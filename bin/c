#!/usr/bin/env bash
set -e
function get_hosts {
    nix eval --raw --impure --expr 'let lib = (import <nixpkgs> {}).lib; in lib.concatStringsSep "\n" (lib.attrNames (removeAttrs (import ./morph.nix) [ "network" "defaults" "resources" "require" "_file" "_metadata" ]))'
}
function morp {
    "$(morph build morph.nix --on=_metadata $morph_extra_args)"/_metadata
    echo morph $@ $morph_extra_args
    morph $@ $morph_extra_args
}


morph_extra_args=""
if [ "$1" == "trace" ]; then
    morph_extra_args="--show-trace"
    shift
fi

action=${2:-deploy}
if [ "$action" == "deploy" ]; then
    deployExtra="switch --passwd"
fi

if [ "$1" == "" ]; then
    morp $action morph.nix $deployExtra --on "$(hostname)"
elif [ "$1" == "all" ]; then
    morp $action morph.nix $deployExtra --tagged=real
elif get_hosts | grep "$1" >/dev/null; then
    morp $action morph.nix $deployExtra --on "$1"
elif [ "$1" == "bump" ]; then
    git stash push
    niv update $2
    git add nix/sources.json 2>&1
    git commit -m "niv: bump $2" 2>&1
    git stash pop >/dev/null
fi
